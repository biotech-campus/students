#!/bin/bash
set -e
# shellcheck disable=SC2086

SING_DIR="/mnt/Storage/testdata/Temp/sing_containers"
REF_DIR="/mnt/Storage/databases/reference"
RESULTS_DIR="/mnt/Storage/testdata/Results"


SLURM_MEMORY=400
SLURM_CPU=42
THREADS=${SLURM_CPU}

IMAGE="${SING_DIR}/megane_1.0.1.sif"


### Params to vary
## HG38
REF_FILE_NAME="GRCh38.d1.vd1.fa"
REF="${REF_DIR}/${REF_FILE_NAME}"
INPUT_SUFFIX="MGI.cutadapt.bwa.MarkDuplicates.bam"
## T2T
# REF_FILE_NAME="GCF_009914755.1_T2T-CHM13v2.0_genomic.fna"
# REF="${REF_DIR}/T2T-CHM13v2.0/GCF_009914755.1/${REF_FILE_NAME}"
# INPUT_SUFFIX="MGI.cutadapt.bwa_T2T-CHM13v2.0.MarkDuplicates.bam"

COHORT_NAME="9_breast_cancer"
# COHORT_NAME="5_norma"
OUTPUT_COHORT_DIR="/mnt/Storage/testdata/Temp/MGE/${COHORT_NAME}"
rm -rvf ${OUTPUT_COHORT_DIR}
mkdir -p ${OUTPUT_COHORT_DIR}

## build one time
TOOL_NAME="megane_build"
echo "Run ${TOOL_NAME}"
MEGANE_BUILD_JOB=$(
    echo -e "#!/bin/bash\n" \
    singularity run \
        --bind ${REF_DIR}:${REF_DIR}:ro \
        --bind ${OUTPUT_COHORT_DIR}:${OUTPUT_COHORT_DIR} \
        --workdir ${OUTPUT_COHORT_DIR} \
        ${IMAGE} \
            build_kmerset \
            -fa ${REF} \
            -outdir ${OUTPUT_COHORT_DIR} |
    sbatch --parsable --job-name ${TOOL_NAME} \
        --mem ${SLURM_MEMORY} --cpus-per-task 1 \
        --time 10:00:00 \
        -o "${OUTPUT_COHORT_DIR}/${TOOL_NAME}.out" \
        -e "${OUTPUT_COHORT_DIR}/${TOOL_NAME}.err" \
        --partition CPU,GPU,DEV --nice=800
)
echo -e "Submited ${TOOL_NAME} ${MEGANE_BUILD_JOB}, \n\t REF ${REF}, \n\t OUTPUT_COHORT_DIR ${OUTPUT_COHORT_DIR}"

rm -vf ${OUTPUT_COHORT_DIR}/dirlist.txt
MEGANE_JOBS=""

## all
# SAMPLES="000009005450 000009005460 000009005470 000009005480 000009005490 000009005500 000009005510 000009005520 000009005530 000009005540 000009005550 000009005560 000009005570 000009005580 000009005590 000009005600 000009005610 000009005620 000009005630 000009005640 000009005650 000009005660 000009005670 000009005680 000009005690 000009005700 000009005710 000009005720 000009005730 000009005740 000009005750 000009005760 000009005770 000009005780 000009005790 000009005800 000009005810 000009005820 000009005830 000009005840 000009005850 000009005860 000009005870 000009005880 000009005890 000009005900 000009005910 000009005920 000009005930 000009005940 000009005950 000009005960 000009005970 000009005980 000009005990 000009006000 000009006010 000009006020 000009006030 000009006040 000009006050 000009006060 000009006070 000009006080 000009006090 000009006100 000009006110 000009006120 000009006130 000009006140 000009006150 000009006160 000009006170 000009006180 000009006190 000009006200 000009006210 000009006220 000009006230 000009006240 000009006250 000009006260 000009006270 000009006280 000009006290 000009006300 000009006310 000009006320 000009006330 000009006340 000009006350 000009006360 000009006370 000009006380 000009006390 000009006400 000009006410 000009006420 000009006430 000009006440 000009006450 000009006460 000009006470 000009006480 000009006490 000009006500 000009006510 000009006520 000009006530 000009006540 000009006550 000009006560 000009006570 000009006580 000009006590 000009006600 000009006610 000009006620 000009006630 000009006640 000009006650 000009006660 000009006670 000009006680 000009006690 000009006700 000009006710 000009006720 000009006730 000009006740 000009006750 000009006760 000009006770 000009006780 000009006790 000009006800 000009006810 000009006820 000009006830 000009006840 000009006850 000009006860 000009006870 000009006880 000009006890 000009006900 000009006910 000009006920 000009006930 000009006940 000009006950 000009006960 000009006970 000009006980 000009006990 000009007000 000009007010 000009007020 000009007030 000009007040 000009007050 000009007060 000009007070 000009007080 000009007090 000009007100 000009007110 000009007120 000009007130 000009007140 000009007150 000009007160 000009007170 000009007180 000009007190 000009007200 000009007210 000009007220 000009007230 000009007240 000009007250 000009007260 000009007270 000009007280 000009007290 000009007300 000009007310 000009007320 000009007330 000009007340 000009007350 000009007360 000009007370 000009007380 000009007390 000009007400 000009007410 000009007420 000009007430 000009007440 000009007450 000009007460 000009007470 000009007480 000009007490 000009007500 000009007510 000009007520 000009007530 000009007540 000009007550 000009007560 000009007570 000009007580 000009007590 000009007600 000009007610 000009007620 000009007630 000009007640 000009007650 000009007660 000009007670 000009007680 000009007690 000009007700 000009007710 000009007720 000009007730 000009007740 000009007750 000009007760 000009007770 000009007780 000009007790 000009007800 000009007810 000009007820 000009007830 000009007840 000009007850 000009007860 000009007870 000009007880 000009007890 000009007900 000009007910 000009007920 000009007930 000009007940 000009007950 000009007960 000009007970 000009007980 000009007990 000009008000 000009008010 000009008020 000009008030 000009008040 000009008050 000009008060 000009008070 "
## small batch
SAMPLES="000009005450 000009005460 "

for SAMPLE in ${SAMPLES}; do
    TOOL_NAME="megane"
    echo "Run ${SAMPLE} ${TOOL_NAME}, depends on ok ${MEGANE_BUILD_JOB}"

    OUTPUT_SUFFIX="${INPUT_SUFFIX%.*}.${TOOL_NAME}"

    PROJECT=${SAMPLE:0:6}
    SAMPLE_DIR="/mnt/Storage/testdata/Results/${PROJECT}/${SAMPLE}"
    INPUT_DIR="${SAMPLE_DIR}/Alignments"
    INPUT="${INPUT_DIR}/${SAMPLE}.${INPUT_SUFFIX}"
    OUTPUT_DIR="${SAMPLE_DIR}/Variation"
    OUTPUT="${OUTPUT_DIR}/${SAMPLE}.${OUTPUT_SUFFIX}"
    JOB_NAME="${TOOL_NAME}-${SAMPLE}"

    ## create if not exists
    if [[ ! -d ${OUTPUT_DIR} ]]; then 
        mkdir -p ${OUTPUT_DIR}
    fi

    ## do / do not rewrite 
    # if [ ! -f ${OUTPUT} ]; then
        MEGANE_JOB=$(
            echo -e "#!/bin/bash\n" \
            singularity run \
                --bind ${REF_DIR}:${REF_DIR}:ro \
                --bind ${INPUT_DIR}:${INPUT_DIR}:ro \
                --bind ${OUTPUT_DIR}:${OUTPUT_DIR} \
                --workdir ${OUTPUT_DIR} \
                ${IMAGE} \
                    call_genotype_38 \
                        -i ${INPUT}\
                        -fa ${REF} \
                        -mk ${OUTPUT_COHORT_DIR}/${REF_FILE_NAME}.mk \
                        -outdir ${OUTPUT} \
                        -p ${THREADS} |
            sbatch --parsable --job-name ${JOB_NAME} \
                --mem ${SLURM_MEMORY} --cpus-per-task ${SLURM_CPU} \
                --time 2-0 \
                -o "${SAMPLE_DIR}/Logs/${SAMPLE}.${OUTPUT_SUFFIX}.out" \
                -e "${SAMPLE_DIR}/Logs/${SAMPLE}.${OUTPUT_SUFFIX}.err" \
                --partition CPU,GPU,DEV --nice=800 \
                --kill-on-invalid-dep=yes \
                --dependency=afterok:${MEGANE_BUILD_JOB}
        )
	    echo -e "Submited ${JOB_NAME} ${MEGANE_JOB}, \n\t INPUT ${INPUT}, \n\t OUTPUT ${OUTPUT}"

        
        MEGANE_JOBS="${MEGANE_JOBS}:${MEGANE_JOB}"
    # fi

    ## collect files to merge
    echo "${OUTPUT}" >> "${OUTPUT_COHORT_DIR}/dirlist.txt"
done


## merge one time
TOOL_NAME="megane_merge"
echo "Run ${TOOL_NAME}, depends on ok ${MEGANE_JOBS}"
INPUT="${OUTPUT_COHORT_DIR}/dirlist.txt"
MEGANE_MERGE_JOB=$(
    echo -e "#!/bin/bash\n" \
    singularity run \
        --bind ${REF_DIR}:${REF_DIR}:ro \
        --bind ${RESULTS_DIR}:${RESULTS_DIR}:ro \
        --bind ${OUTPUT_COHORT_DIR}:${OUTPUT_COHORT_DIR} \
        --workdir ${OUTPUT_COHORT_DIR} \
        ${IMAGE} \
            joint_calling_hs \
            -merge_mei  \
            -f ${INPUT} \
            -fa ${REF} \
            -cohort_name ${COHORT_NAME} \
            -p ${THREADS} |
    sbatch --parsable --job-name ${TOOL_NAME} \
        --mem ${SLURM_MEMORY} --cpus-per-task ${SLURM_CPU} \
        --time 4-0 \
        -o "${OUTPUT_COHORT_DIR}/${TOOL_NAME}.out" \
        -e "${OUTPUT_COHORT_DIR}/${TOOL_NAME}.err" \
        --partition CPU,GPU,DEV --nice=800 \
        --kill-on-invalid-dep=yes --dependency=afterok${MEGANE_JOBS}
)
echo -e "Submited ${TOOL_NAME} ${MEGANE_MERGE_JOB}, \n\t INPUT ${INPUT}, \n\t OUTPUT_COHORT_DIR ${OUTPUT_COHORT_DIR}"

